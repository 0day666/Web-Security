# CSRF漏洞

------

## 漏洞简介

```php
 CSRF（Cross-site request forgery）跨站请求伪造：攻击者诱导受害者进入第三方网站，在第三方网站中，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到冒充用户对被攻击的网站执行某项操作的目的
```

------

## 漏洞原理

```php
  CSRF漏洞是因为web应用程序在用户进行敏感操作时，如修改账号密码、添加账号、转账等，没有校验表单token或者http请求头中的referer值，从而导致恶意攻击者利用普通用户的身份（cookie）完成攻击行为
  由于目标网站无token或referer限制，攻击者可以利用用户的身份，执行请求
  跨站请求伪造，利用了网站允许攻击者预测特定操作所有细节这一特点。由于浏览器自动发送会话cookie等认证凭证，导致攻击者可以创建恶意的web页面来产生伪造请求。这些伪造的请求很难和合法的请求区分开
例如:
银行网站A，它以GET请求来完成银行转账的操作，如：
 http://www.mybank.com/Transfer.php?toBankId=11&money=1000
危险网站B，它里面有一段HTML的代码如下：
 <img src=http://www.mybank.com/Transfer.php?toBankId=11&money=1000>
登陆银行网站A后，在同一个浏览器去访问B网站的一个上面的请求，这个时候会发现你的账户会少了1000块。
```

------

## 漏洞危害

```php
攻击者可以让受害者用户修改任何允许修改的数据，执行任何用户允许的操作，例如修改密码，登录注销等
```

------

## 漏洞测试

### **GET类型的CSRF的检测**

```php
如果有token等验证参数，先去掉参数尝试能否正常请求。如果可以，即存在CSRF漏洞
```

### **POST类型的CSRF的检测**

```php
如果有token等验证参数，先去掉参数尝试能否正常请求。如果可以，再去掉referer参数的内容，如果仍然可以，说明存在CSRF漏洞，可以利用构造外部form表单的形式，实现攻击。如果直接去掉referer参数请求失败，这种还可以继续验证对referer的判断是否严格，是否可以绕过
```

### csrf与xss区别

````php
XSS：跨站脚本（Cross-site scripting，通常简称为XSS）是一种网站应用程序的安全漏洞攻击，是代码注入的一种。它允许恶意用户将代码注入到网页上，其他用户在观看网页时就会受到影响。这类攻击通常包含了HTML以及客户端脚本语言（最常见如：JavaScript）

XSS更偏向于方法论，CSRF更偏向于一种形式，只要是伪造用户发起的请求，都可成为CSRF攻击。

通常来说CSRF是由XSS实现的，所以CSRF时常也被称为XSRF[用XSS的方式实现伪造请求]（但实现的方式绝不止一种，还可以直接通过命令行模式（命令行敲命令来发起请求）直接伪造请求[只要通过合法验证即可]）。

XSS更偏向于代码实现（即写一段拥有跨站请求功能的JavaScript脚本注入到一条帖子里，然后有用户访问了这个帖子，这就算是中了XSS攻击了），CSRF更偏向于一个攻击结果，只要发起了冒牌请求那么就算是CSRF了
````



------

## 漏洞修复

* **添加验证码**：在一些特殊请求页面增加验证码，验证码强制用户必须与应用进行交互，才能完成最终请求

* **检测refer**：检测refer值，来判断请求来源是否合法。

* **Token**：在每个请求中设置Token是一种流行的方式来防御CSRF。CSRF攻击的原理：攻击者可以猜测到用户请求，现在在每个请求中加一个随机的Toekn值。

  Token要足够随机————只有这样才算不可预测

  Token是一次性的，即每次请求成功后要更新Token————这样可以增加攻击难度，增加预测难度

  Token要注意保密性————敏感操作使用post，防止Token出现在URL中

